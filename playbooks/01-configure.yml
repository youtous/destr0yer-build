---
# Provision servers using a global policy
- name: Ensure server_environment is defined and not empty
  hosts: all
  gather_facts: false
  tasks:
    - name: "Check"
      ansible.builtin.assert:
        that: >
          server_environment is defined and server_environment|length
        msg: "server_environment must be defined an not empty"

- name: Configure systems | disk partitioning with LVM
  hosts: systems
  roles:
    - disks_lvm_management
    - swap
    - mount
  vars_files:
    - ../secret_vars/{{ server_environment }}/all.yml
    - ../task_vars/sudo.yml
    - "../secret_vars/{{ server_environment }}/{{ inventory_hostname }}.yml"
  tags: ["disk-partitioning", "configure-systems", "swap"]

- name: Configure systems | apt packages configuration and update
  hosts: systems
  serial: 1 # configure one by one each host in case of docker update/kernel reboot
  roles:
    - apt
  vars_files:
    - ../secret_vars/{{ server_environment }}/all.yml
    - ../task_vars/sudo.yml
    - "../secret_vars/{{ server_environment }}/{{ inventory_hostname }}.yml"
  tags: ["apt", "configure-systems"]

- name: Configure systems | minimal requirements
  hosts: systems
  roles:
    - system_packages # system packages (htop, curl etc)
    - host # configure system host files
    - chronyd # chronyd
    - system_configuration # configure the system (selinux, timezone...)
    - system_tools # server cli tools (vim, etc)
    - iptables_firewall # define firewall policy
  vars_files:
    - ../secret_vars/{{ server_environment }}/all.yml
    - ../task_vars/sudo.yml
    - "../secret_vars/{{ server_environment }}/{{ inventory_hostname }}.yml"
  tags: ["system", "configure-systems", "minimal"]

- name: Configure systems | configure kernel
  hosts: systems
  serial: 1 # configure one by one each host in case of reboot
  roles:
    - sysctl_configuration
  vars_files:
    - ../secret_vars/{{ server_environment }}/all.yml
    - ../task_vars/sudo.yml
    - "../secret_vars/{{ server_environment }}/{{ inventory_hostname }}.yml"
  tags: ["sysctl", "configure-systems"]

- name: Configure systems | manage users
  hosts: systems
  roles:
    - users
    - ssh_user_keys
    - restrict_user_ssh_ips
  vars_files:
    - ../secret_vars/{{ server_environment }}/all.yml
    - ../task_vars/sudo.yml
    - "../secret_vars/{{ server_environment }}/{{ inventory_hostname }}.yml"
  tags: ["users", "configure-systems"]

- name: Configure systems | configure OpenSSH
  hosts: systems
  roles:
    - ssh
    - motd
    - notify_login # notify when an user connects
  vars_files:
    - ../secret_vars/{{ server_environment }}/all.yml
    - ../task_vars/sudo.yml
    - "../secret_vars/{{ server_environment }}/{{ inventory_hostname }}.yml"
  tags: ["ssh", "sshd", "configure-systems"]


- name: Configure systems | configure log management
  hosts: systems
  roles:
    - logrotate
  vars_files:
    - ../secret_vars/{{ server_environment }}/all.yml
    - ../task_vars/sudo.yml
    - "../secret_vars/{{ server_environment }}/{{ inventory_hostname }}.yml"
  tags: ["log", "logrotate", "configure-systems"]

- name: Configure systems | monit
  hosts: systems
  roles:
    - monit
  vars_files:
    - ../secret_vars/{{ server_environment }}/all.yml
    - ../task_vars/sudo.yml
    - "../secret_vars/{{ server_environment }}/{{ inventory_hostname }}.yml"
  tags: ["monit", "configure-systems"]

- name: Configure systems | fail2ban
  hosts: systems
  roles:
    - fail2ban
    - monit_fail2ban
  vars_files:
    - ../secret_vars/{{ server_environment }}/all.yml
    - ../task_vars/sudo.yml
    - "../secret_vars/{{ server_environment }}/{{ inventory_hostname }}.yml"
  tags: ["fail2ban", "configure-systems"]

- name: Configure systems | filter ips for base systems (entrypoint required)
  hosts: [base_systems]
  roles:
    - entrypoint_ssh
  vars_files:
    - ../secret_vars/{{ server_environment }}/all.yml
    - ../task_vars/sudo.yml
    - "../secret_vars/{{ server_environment }}/{{ inventory_hostname }}.yml"
  tags: ["entrypoint_ssh", "ssh", "sshd", "configure-systems"]

- name: Configure systems | resolv dns configuration
  hosts: systems
  roles:
    - dnscrypt_proxy # DNS with TLS
    - monit_dnscrypt_proxy
    - resolv
  vars_files:
    - ../secret_vars/{{ server_environment }}/all.yml
    - ../task_vars/sudo.yml
    - "../secret_vars/{{ server_environment }}/{{ inventory_hostname }}.yml"
  tags: ["resolv", "configure-systems", "dnscrypt_proxy"]

- name: Configure systems | hardening
  hosts: systems
  roles:
    - hardening # hardening systems
    - scaleway_services # define services policy for scaleway
  vars_files:
    - ../secret_vars/{{ server_environment }}/all.yml
    - ../task_vars/sudo.yml
    - "../secret_vars/{{ server_environment }}/{{ inventory_hostname }}.yml"
  tags: ["hardening", "configure-systems"]

- name: Configure systems | sysstat
  hosts: systems
  roles:
    - sysstat # resource monitoring
  vars_files:
    - ../secret_vars/{{ server_environment }}/all.yml
    - ../task_vars/sudo.yml
    - "../secret_vars/{{ server_environment }}/{{ inventory_hostname }}.yml"
  tags: ["sysstat", "configure-systems"]

- name: Configure systems | logwatch
  hosts: systems
  roles:
    - logwatch # monitor server using emails
  vars_files:
    - ../secret_vars/{{ server_environment }}/all.yml
    - ../task_vars/sudo.yml
    - "../secret_vars/{{ server_environment }}/{{ inventory_hostname }}.yml"
  tags: ["logwatch", "configure-systems"]

- name: Configure systems with specifics interfaces
  hosts: interfaces
  roles:
    - network
  vars_files:
    - ../secret_vars/{{ server_environment }}/all.yml
    - ../task_vars/sudo.yml
    - "../secret_vars/{{ server_environment }}/{{ inventory_hostname }}.yml"
  tags: ["interfaces"]

- name: Configure systems | configure fish shell
  hosts: systems
  roles:
    - oh_my_fish
  vars_files:
    - ../secret_vars/{{ server_environment }}/all.yml
    - ../task_vars/sudo.yml
    - "../secret_vars/{{ server_environment }}/{{ inventory_hostname }}.yml"
  tags: ["fish", "configure-systems"]

- name: Configure systems | glances
  hosts: systems
  roles:
    - glances # boosted htop
  vars_files:
    - ../secret_vars/{{ server_environment }}/all.yml
    - ../task_vars/sudo.yml
    - "../secret_vars/{{ server_environment }}/{{ inventory_hostname }}.yml"
  tags: ["configure-systems", "update-systems"]

- name: Configure Postfix relay servers
  hosts: smtp_relays
  roles:
    - postfix_relay
  vars_files:
    - ../secret_vars/{{ server_environment }}/all.yml
    - ../task_vars/sudo.yml
    - "../secret_vars/{{ server_environment }}/{{ inventory_hostname }}.yml"
  tags: ["smtp-relay"]

- name: Configure backup storage systems
  hosts: backup_storage
  roles:
    - backup_storage
  vars_files:
    - ../secret_vars/{{ server_environment }}/all.yml
    - ../task_vars/sudo.yml
    - "../secret_vars/{{ server_environment }}/{{ inventory_hostname }}.yml"
  tags: ["backup_storage"]

- name: Configure backed-up systems
  hosts: backed_up_hosts
  roles:
    - backup_strategy
  vars_files:
    - ../secret_vars/{{ server_environment }}/all.yml
    - ../task_vars/sudo.yml
    - "../secret_vars/{{ server_environment }}/{{ inventory_hostname }}.yml"
  tags: ["backup_strategy"]

- name: Configure database servers
  hosts: database_servers
  roles:
    - mariadb_server
    - monit_mariadb
    - backup_mariadb
  vars_files:
    - ../secret_vars/{{ server_environment }}/all.yml
    - ../task_vars/sudo.yml
    - "../secret_vars/{{ server_environment }}/{{ inventory_hostname }}.yml"
  tags: ["database-servers", "database"]

- name: Configure database clients
  hosts: database_clients
  roles:
    - mariadb_client
  vars_files:
    - ../secret_vars/{{ server_environment }}/all.yml
    - ../task_vars/sudo.yml
    - "../secret_vars/{{ server_environment }}/{{ inventory_hostname }}.yml"
  tags: ["database-clients", "database"]

- name: Configure WireGuard peers
  hosts: wireguard_peers
  roles:
    - wireguard_meta
  vars_files:
    - ../secret_vars/{{ server_environment }}/all.yml
    - ../task_vars/sudo.yml
    - "../secret_vars/{{ server_environment }}/{{ inventory_hostname }}.yml"
  tags: ["wireguard"]

- name: Watch servers ips
  hosts: watch_ip
  roles:
    - notify_ip_change
  vars_files:
    - ../secret_vars/{{ server_environment }}/all.yml
    - ../task_vars/sudo.yml
    - "../secret_vars/{{ server_environment }}/{{ inventory_hostname }}.yml"
  tags: ["watch-ip"]

- name: Monitor ssl hosts
  hosts: watch_ssl
  roles:
    - monitor_testssl
  vars_files:
    - ../secret_vars/{{ server_environment }}/all.yml
    - ../task_vars/sudo.yml
    - "../secret_vars/{{ server_environment }}/{{ inventory_hostname }}.yml"
  tags: ["watch-ssl"]
...
