---
# This play a docker swarm cluster.
- name: Ensure server_environment is defined and not empty
  hosts: all
  gather_facts: false
  tasks:
    - name: "Check"
      ansible.builtin.assert:
        that: >
          server_environment is defined and server_environment|length
        msg: "server_environment must be defined an not empty"

- name: Install k3s on nodes
  hosts: k3s
  roles:
    - k3s
    - monit_k3s
    - k8s_helm
    - k8s_cilium_cli
    - k3s_cilium_firewall
    - k8s_k9s
  vars_files:
    - ../secret_vars/{{ server_environment }}/all.yml
    - ../task_vars/sudo.yml
    - "../secret_vars/{{ server_environment }}/{{ inventory_hostname }}.yml"
  tags: ["k3s-setup"]

- name: Generate admin service account on controllers
  hosts: k3s_control_node
  roles:
    - k8s_service_account_admin # TODO document
  vars_files:
    - ../secret_vars/{{ server_environment }}/all.yml
    - ../task_vars/sudo.yml
    - "../secret_vars/{{ server_environment }}/{{ inventory_hostname }}.yml"
  tags: ["k3s-setup", "k3s-service-account"]

- name: Install k3s internal services
  hosts: k3s_control_node[0]
  roles:
    - k3s_cilium
    - k3s_certmanager
    - k3s_haproxy
    - k8s_haproxy_whoami
    - k3s_k8s_dashboard
    - k3s_promgraf
  vars_files:
    - ../secret_vars/{{ server_environment }}/all.yml
    - ../task_vars/sudo.yml
    - "../secret_vars/{{ server_environment }}/{{ inventory_hostname }}.yml"
  tags: ["k3s-setup", "k3s-internal-services"]

- name: Generate service accounts and namespaces
  hosts: k3s_control_node
  roles:
    - k8s_accounts # TODO document
  vars_files:
    - ../secret_vars/{{ server_environment }}/all.yml
    - ../task_vars/sudo.yml
    - "../secret_vars/{{ server_environment }}/{{ inventory_hostname }}.yml"
  tags: ["k3s-accounts"]

# TODO : ensure prune daily k3s
# TODO : Integrate fail2ban for k3s (recidive)
# TODO : check how iptable chain is handled
# TODO : tooling, ctop
# TODO : setup k3s backup
# TODO : configure reverse proxy + ACME + f2b on those
# TODO : setup promgraf
# TODO : setup elastic / alternative lightweight : https://github.com/openobserve/openobserve/tree/main/deploy
# TODO : setup mailserver
# TODO : setup nextcloud
# TODO : setup teamspeak
...
