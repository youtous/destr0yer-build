---
# This play a docker swarm cluster.
- name: Ensure server_environment is defined and not empty
  hosts: all
  gather_facts: false
  tasks:
    - name: "Check"
      ansible.builtin.assert:
        that: >
          server_environment is defined and server_environment|length
        msg: "server_environment must be defined an not empty"


- name: Install k3s on nodes
  hosts: k3s
  roles:
    - k3s
    - k8s_helm
    # - monit_k3s # TODO : create k3s monit role
  vars_files:
    - ../secret_vars/{{ server_environment }}/all.yml
    - ../task_vars/sudo.yml
    - "../secret_vars/{{ server_environment }}/{{ inventory_hostname }}.yml"
  tags: ["k3s-setup"]


# TODO : ensure prune daily k3s
# TODO : Integrate fail2ban for k3s (recidive)
# TODO : check how iptable chain is handled
# TODO : tooling, k9s, ctop
# TODO : setup k3s backup
# TODO : configure reverse proxy + ACME + f2b on those
# TODO : setup portainer
# TODO : setup promgraf
# TODO : setup elastic
# TODO : setup mailserver
# TODO : setup nextcloud
# TODO : setup teamspeak
...
