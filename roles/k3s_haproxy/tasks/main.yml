---
- name: Create build directory
  ansible.builtin.tempfile:
    state: directory
    suffix: build
  register: tmp_dir_build

- name: Git clone helm repo
  ansible.builtin.git:
    repo: "{{ haproxy_git_repository }}"
    dest: "{{ tmp_dir_build.path }}"
    version: "{{ haproxy_git_version }}"

- name: Install HAProxy chart
  kubernetes.core.helm:
    name: "{{ haproxy_helm_release_name }}"
    chart_ref: "{{ tmp_dir_build.path }}/kubernetes-ingress"
    release_namespace: "{{ haproxy_k8s_namespace }}"
    create_namespace: true
    values: "{{ haproxy_k8s_helm_values }}"
  register: haproxy__helm_install_chart
  environment:
    KUBECONFIG: "{{ haproxy_kubeconfig_path }}"

- name: Show install helm chart command
  when:
    - haproxy__helm_install_chart is defined
    - haproxy__helm_install_chart.stdout is defined
    - haproxy_helm_show_commands
  ansible.builtin.debug:
    var: haproxy__helm_install_chart.stdout

- name: Cleanup build directory
  ansible.builtin.file:
    state: absent
    path: "{{ tmp_dir_build.path }}"
...
