---
# save the docker-user chain accross rebots

## save ipv4 rules across reboots
- name: Export DOCKER-USER iptables chain
  become: yes
  shell: iptables -S DOCKER-USER
  register: iptables_docker_user_rules
  ignore_errors: True
  listen: register fail2ban chain
  notify: save ipv4 docker chain

- name: Save DOCKER-USER iptables rules
  become: yes
  blockinfile:
    create: yes
    dest: "/etc/iptables.docker-user.rules.v4"
    block: |
      *filter

      {{ iptables_docker_user_rules.stdout }}

      COMMIT
    marker: "### {mark} ANSIBLE MANAGED BLOCK - IPv4 DOCKER-USER before rules ###"
  listen: save ipv4 docker chain
  when: iptables_docker_user_rules is not failed

## save ipv6 rules across reboots
- name: Export DOCKER-USER ip6tables chain
  become: yes
  shell: ip6tables -S DOCKER-USER
  register: ip6tables_docker_user_rules
  ignore_errors: True
  listen: register fail2ban chain
  notify: save ipv4 docker chain

- name: Save DOCKER-USER ip6tables rules
  become: yes
  blockinfile:
    create: yes
    dest: "/etc/iptables.docker-user.rules.v6"
    block: |
      *filter

      {{ ip6tables_docker_user_rules.stdout }}

      COMMIT
    marker: "### {mark} ANSIBLE MANAGED BLOCK - IPv6 DOCKER-USER before rules ###"
  listen: save ipv6 docker chain
  when: ip6tables_docker_user_rules is not failed
...