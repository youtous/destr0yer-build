---
# This role contains the default policy for fail2ban
- name: Include default vars
  include_vars: default.yml

- name: Setup fail2ban
  become: yes
  import_role:
    name: oefenweb.fail2ban
  vars:
    fail2ban_ignoreips: "{{ fail2ban_ignoreips }}"
    fail2ban_destemail: "{{ fail2ban_destemail }}"
    fail2ban_services: "{{ fail2ban_services }}"

- name: Update fail2ban using latest version from strech-backport (handle ipv6)
  become: yes
  apt:
    name: fail2ban
    state: latest
    default_release: strech-backports
    update_cache: yes
  notify:
    - restart fail2ban
  when: ansible_os_family == "Debian" and ansible_lsb.major_release|int < 10

- name: Monit fail2ban
  import_role:
    name: monit-fail2ban

- name: Configure logrotate for fail2ban
  import_role:
    name: logrotate
  vars:
    logrotate_applications:
      - name: fail2ban
        definitions:
          - logs:
              - "{{ fail2ban_logtarget }}"
            options:
              - monthly
              - rotate 12
              - size 10M
              - compress
              - delaycompress
              - missingok
              - notifempty
              - create 0640 root root