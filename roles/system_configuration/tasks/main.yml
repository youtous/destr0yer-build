---
# This role contains base system configuration
- name: "Set timezone to {{ timezone }}"
  become: true
  community.general.timezone:
    name: "{{ timezone }}"

- name: Ensure system folder permissions are correct
  become: true
  ansible.builtin.file:
    path: "{{ item }}"
    owner: root
    group: root
    mode: u=rwx,g=rx,o=rx
  with_items: "{{ system_folders_write_root_only }}"

- name: Register server environment in /etc/server_environment (dev,prod,test)
  become: true
  ansible.builtin.copy:
    content: "{{ server_environment }}"
    dest: /etc/server_environment
    mode: u=rw,g=r,o=r

- name: Add /usr/sbin to PATH bash
  become: true
  ansible.builtin.copy:
    src: files/usr-sbin.sh
    dest: /etc/profile.d/usr-sbin.sh
    owner: root
    group: root
    mode: u=rw,g=rx,o=rx

- name: Add /usr/sbin to PATH fish
  become: true
  ansible.builtin.copy:
    src: files/usr-sbin.fish
    dest: /etc/fish/conf.d/usr-sbin.fish
    owner: root
    group: root
    mode: u=rw,g=rx,o=rx

- name: Gather Scaleway host command information
  ansible.builtin.stat:
    path: /usr/local/bin/scw-metadata
  register: scaleway_scw_medata

- name: Check if host is a Scaleway aarch
  ansible.builtin.shell:
    set -o pipefail &&
    scw-metadata | grep aarch
  changed_when: false
  register: host_scw_aarch64
  when: scaleway_scw_medata.stat.exists
  args:
    executable: /bin/bash

- name: Fix Scaleway reboot command fish
  become: true
  ansible.builtin.copy:
    src: files/reboot.fish
    dest: /etc/fish/conf.d/reboot.fish
    owner: root
    group: root
    mode: u=rw,g=rx,o=rx
  when: scaleway_scw_medata.stat.exists and host_scw_aarch64 is not failed

- name: Fix Scaleway reboot command bash
  become: true
  ansible.builtin.copy:
    src: files/reboot.sh
    dest: /etc/profile.d/reboot.sh
    owner: root
    group: root
    mode: u=rw,g=rx,o=rx
  when: scaleway_scw_medata.stat.exists and host_scw_aarch64 is not failed
...
