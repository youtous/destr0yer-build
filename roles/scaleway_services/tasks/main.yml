---
# This role contains default services settings
- name: List enabled Scaleway services
  become: true
  ansible.builtin.shell: >
    set -o pipefail &&
    systemctl list-unit-files --state=enabled | grep -o -P "scw(\-|\w|\d)*"
  # noqa command-instead-of-module
  changed_when: false
  register: scw_services_enabled
  ignore_errors: true
  args:
    executable: /bin/bash

- name: List running Scaleway services
  become: true
  ansible.builtin.shell: >
    set -o pipefail &&
    systemctl --state=running | grep -o -P "scw(\-|\w|\d)*"
  # noqa command-instead-of-module
  changed_when: false
  register: scw_services_running
  ignore_errors: true
  args:
    executable: /bin/bash

- name: Stop Scaleway services
  become: true
  ansible.builtin.service:
    name: "{{ item }}"
    state: stopped
    enabled: false
  with_items: "{{ scw_services_running.stdout_lines | default([]) + scw_services_enabled.stdout_lines | default([]) }}"
...
