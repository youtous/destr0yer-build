---
# This role contains docker installation
- name: Install python docker modules
  become: true
  ansible.builtin.apt:
    name:
      - python3-docker
      - python3-jsondiff
      - python3-yaml

- name: Install pass package required for docker-login
  become: true
  ansible.builtin.apt:
    name:
      - pass

- name: Ensure old docker-py pip module is absent
  become: true
  ansible.builtin.pip:
    executable: pip3
    name: docker-py
    state: absent

- name: Ensure docker pip module is installed and updated
  become: true
  ansible.builtin.pip: # noqa package-latest
    executable: pip3
    name: docker
    state: latest
    extra_args: --upgrade --break-system-packages

- name: Ensure docker group is present
  become: true
  ansible.builtin.group:
    gid: "{{ docker_group_gid }}"
    name: "{{ docker_group_name }}"

- name: "Adding to docker group user: {{ ansible_user }}"
  become: true
  block:
    - name: "Add docker group to ansible user"
      ansible.builtin.user:
        name: "{{ ansible_user }}"
        groups: "{{ docker_group_name }}"
        append: true
    - name: "Reset connection to apply new group"
      ansible.builtin.meta: reset_connection

- name: Setup docker
  become: true
  ansible.builtin.import_role:
    name: geerlingguy.docker
  vars:
    docker_apt_arch: "{{ 'arm64' if (ansible_architecture == 'aarch64') else 'amd64' }}"

- name: Apply docker systemd fix
  ansible.builtin.import_role:
    name: docker_healthcheck_systemd

- name: Add fail2ban docker filters
  ansible.builtin.import_role:
    name: fail2ban_docker
...
