---
# This role contains docker installation
- name: Install python docker modules
  become: True
  apt:
    name:
      - python3-docker
      - python3-jsondiff
      - python3-yaml

- name: Install pass package required for docker-login
  become: True
  apt:
    name:
      - pass

- name: Ensure old docker-py pip module is absent
  become: True
  pip:
    executable: pip3
    name: docker-py
    state: absent

- name: Ensure docker pip module is installed and updated
  become: True
  pip:
    executable: pip3
    name: docker
    state: latest
    extra_args: --upgrade

- name: Ensure docker group is present
  become: True
  group:
    gid: "{{ docker_group_gid }}"
    name: "{{ docker_group_name }}"

- name: Adding user '{{ ansible_user }}' to docker group
  become: True
  block:
    - user:
        name: "{{ ansible_user }}"
        groups: "{{ docker_group_name }}"
        append: true
    - meta: reset_connection

- name: Setup docker
  become: True
  import_role:
    name: geerlingguy.docker
  vars:
    docker_apt_arch: "{{ 'arm64' if (ansible_architecture == 'aarch64') else 'amd64' }}"

- name: Apply docker systemd fix
  import_role:
    name: docker-healthcheck-systemd

- name: Add fail2ban docker filters
  import_role:
    name: fail2ban-docker
...
