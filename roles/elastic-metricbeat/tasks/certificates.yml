---
# Setup the required components to send metrics to the logstash processor node.

# Setup TLS using x509 certificates
- name: Setup metricbeat certificates folder
  become: true
  ansible.builtin.file:
    path: "{{ metricbeat_certificates_directory }}"
    owner: root
    group: root
    state: directory
    mode: u=rwx,g=,o=

- name: Ensure logstash root CA is defined
  ansible.builtin.fail:
    msg: root CA is empty or not defined.
  when: logstash_ca_certificate is not defined or logstash_ca_certificate|length == 0

- name: Ensure logstash node crt is defined
  ansible.builtin.fail:
    msg: crt is empty or not defined.
  when: metricbeat_node_certificate is not defined or metricbeat_node_certificate|length == 0

- name: Ensure logstash node key is defined
  ansible.builtin.fail:
    msg: key is empty or not defined.
  when: metricbeat_node_private_key is not defined or metricbeat_node_private_key|length == 0


- name: Copy logstash RootCA certificate
  become: true
  ansible.builtin.copy:
    content: "{{ logstash_ca_certificate }}"
    dest: "{{ metricbeat_certificates_directory }}/{{ logstash_root_ca_certificate_name }}"
    owner: root
    group: root
    mode: u=rw,g=,o=
  notify:
    - restart metricbeat

- name: Copy metricbeat node certificate
  become: true
  ansible.builtin.copy:
    content: "{{ metricbeat_node_certificate }}"
    dest: "{{ metricbeat_certificates_directory }}/{{ metricbeat_node_certificate_name }}.crt"
    owner: root
    group: root
    mode: u=rw,g=,o=
  notify:
    - restart metricbeat

- name: Copy metricbeat node private key
  become: true
  ansible.builtin.copy:
    content: "{{ metricbeat_node_private_key }}"
    dest: "{{ metricbeat_certificates_directory }}/{{ metricbeat_node_certificate_name }}.key"
    owner: root
    group: root
    mode: u=rw,g=,o=
  no_log: true
  notify:
    - restart metricbeat
...
