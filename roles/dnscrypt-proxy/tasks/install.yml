---
- name: Install building requirements
  become: yes
  apt:
    state: present
    name:
      - golang-github-jedisct1-go-minisign-dev

- name: Ensure any existing DNSCrypt-proxy vestige is removed
  become: yes
  apt:
    state: absent
    name:
      - dnscrypt-proxy

- name: Create buid directory
  tempfile:
    state: directory
    suffix: build
    register: tmp_dir_build

- name: Retrieve latest DNSCrypt-proxy from repo
  shell: >
    curl -sL {{ dnscrypt_proxy_repo|quote }} | grep "tag_name" | head -1 | cut -d \" -f 4
  register: dnscrypt_remote_download
  when: dnscrypt_proxy_version == "latest"

- name: Download latest DNSCrypt-proxy for local installation
  get_url:
    url: "{{ item.url }}"
    dest: "{{ tmp_dir_build.path }}/{{ item.filename }}"
    mode: u=rwx,g=,o=
  with_items:
    - { url: "{{ dnscrypt_remote_download.stdout }}", filename: "dnscrypt-proxy.tar.gz" }
    - { url: "{{ dnscrypt_remote_download.stdout }}.minisig", filename: "dnscrypt-proxy.tar.gz.minisig" }
  when: dnscrypt_proxy_version == "latest"

- name: Download specific version of DNSCrypt-proxy for local installation
  get_url:
    url: "{{ item.url }}"
    dest: "{{ tmp_dir_build.path }}/{{ item.filename }}"
    mode: u=rwx,g=,o=
  with_items:
    - { url: "{{ dnscrypt_proxy_custom_version_download_url }}", filename: "dnscrypt-proxy.tar.gz" }
    - { url: "{{ dnscrypt_proxy_custom_version_download_url }}.minisig", filename: "dnscrypt-proxy.tar.gz.minisig" }
  when: dnscrypt_proxy_version != "latest"

- name: Verify downloaded files
  shell: >
    minisign -Vm "{{ tmp_dir_build.path|quote }}/dnscrypt-proxy.tar.gz" -P "{{ dnscrypt_proxy_public_key|quote }}"

- name: Extract downloaded files
  unarchive:
    src: "{{ tmp_dir_build.path }}/dnscrypt-proxy.tar.gz"
    dest: "{{ tmp_dir_build.path }}"

- name: Copy DNSCrypt-proxy in system binaries
  become: yes
  copy:
    src: "{{ tmp_dir_build.path }}/{{ dnscrypt_proxy_platform }}-{{ dnscrypt_proxy_cpu_platform }}/dnscrypt-proxy"
    dest: "{{ dnscrypt_binary_path }}"
    owner: root
    group: root
    mode: u=rwx,g=xr,o=x
  notify: restart dnscrypt-proxy

- name: Cleanup build directory
  become: yes
  file:
    state: absent
    path: "{{ tmp_dir_build.path }}"
...