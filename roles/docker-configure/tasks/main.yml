---
# This role contains docker configure docker in a swarm mode configuration.
# Various configurations can be applied using this role;
# In order to have a working TLS cluster, it is required to deploy certificates.
# Each node will receive the ROOT cert-key, his own private and public key (3 files).

- name: Setup docker certificates folder
  become: true
  file:
    path: "{{ docker_swarm_certificates_directory }}"
    state: directory
    owner: root
    group: root
    mode: u=rwx,g=,o=

# Swarm configuration

- name: Ensure swarm root CA is defined
  fail:
    msg: root CA is empty or not defined.
  when: docker_swarm_CA_certificate is not defined or docker_swarm_CA_certificate|length == 0

- name: Ensure swarm node crt is defined
  fail:
    msg: crt is empty or not defined.
  when: docker_swarm_node_certificate is not defined or docker_swarm_node_certificate|length == 0

- name: Ensure swarm node key is defined
  fail:
    msg: key is empty or not defined.
  when: docker_swarm_node_private_key is not defined or docker_swarm_node_private_key|length == 0

- name: Copy RootCA certificate
  become: true
  copy:
    content: "{{ docker_swarm_CA_certificate }}"
    dest: "{{ docker_swarm_certificates_directory }}/{{ docker_swarm_root_CA_certificate_name }}"
    owner: root
    group: root
    mode: u=rw,g=,o=
  notify:
    - restart docker

- name: Copy node certificate
  become: true
  copy:
    content: "{{ docker_swarm_node_certificate }}"
    dest: "{{ docker_swarm_certificates_directory }}/{{ docker_swarm_node_certificate_name }}.crt"
    owner: root
    group: root
    mode: u=rw,g=,o=
  notify:
    - restart docker

- name: Copy node private key
  become: true
  copy:
    content: "{{ docker_swarm_node_private_key }}"
    dest: "{{ docker_swarm_certificates_directory }}/{{ docker_swarm_node_certificate_name }}.key"
    owner: root
    group: root
    mode: u=rw,g=,o=
  no_log: true
  notify:
    - restart docker

- name: Create systemd docker.service.d directory
  become: true
  file:
    path: /etc/systemd/system/docker.service.d
    state: directory
    owner: root
    group: root
    mode: u=rwx,g=,o=

- name: Override default systemd docker exec start
  become: true
  copy:
    src: files/override.conf
    dest: /etc/systemd/system/docker.service.d/override.conf
    owner: root
    group: root
    mode: u=rw,g=,o=
  notify:
    - daemon-reload systemd
    - restart docker

# Docker DNS configuration
- name: Register docker0 host ip
  shell: >
    set -o pipefail &&
    ip -4 addr show docker0 | grep -Po 'inet \K[\d.]+'
  args:
    executable: /bin/bash
  changed_when: false
  register: docker_host_docker0_ip_register

- name: Register docker_gwbridge host ip
  shell: >
    set -o pipefail &&
    ip -4 addr show docker_gwbridge | grep -Po 'inet \K[\d.]+'
  args:
    executable: /bin/bash
  changed_when: false
  ignore_errors: true
  register: docker_host_docker_gwbridge_ip_register

# Configure docker logging system
- name: Setup docker rsyslog config
  become: true
  template:
    src: files/10-docker.conf.j2
    dest: /etc/rsyslog.d/10-docker.conf
  notify:
    - restart rsyslog
  when: docker_log_backend == 'rsyslog'

- name: Prevent duplicates from journald to rsyslog when using docker with journald
  become: true
  import_role:
    name: 0x0I.journald
  vars:
    journald_configs:
      - config:
          ForwardToSyslog: false

- name: Configure logrotate for docker rsyslog
  import_role:
    name: logrotate
  vars:
    logrotate_applications:
      - name: docker
        definitions:
          - logs:
              - "{{ docker_log_file }}"
            options:
              - monthly
              - rotate 12
              - size {{ docker_log_max_size }}
              - compress
              - delaycompress
              - missingok
              - notifempty
              - create 0640 root root
  when: docker_log_backend == 'rsyslog'

- name: Copy docker daemon configuration
  become: true
  template:
    src: files/daemon.json.j2
    # host is used to listen orders from a specific ip,
    # in this configuration, we assume that all of our docker nodes can send an order to other docker nodes.
    dest: /etc/docker/daemon.json
    owner: root
    group: root
    mode: u=rw,g=,o=
  notify:
    - restart docker

- name: Firewall
  import_tasks: firewall.yml
