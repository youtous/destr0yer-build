---
- name: Install GPG - required to add wireguard key
  become: true
  ansible.builtin.apt:
    name: gnupg2
    state: present


- name: Get architecture
  ansible.builtin.command: dpkg --print-architecture
  register: dpkg_arch
  changed_when: false

- name: Install kernel headers to compile wireguard with DKMS
  become: true
  ansible.builtin.apt:
    name:
      - "linux-headers-{{ dpkg_arch.stdout }}"
    state: present
    update_cache: true

- name: Install wiregard using latest version from buster-backport
  become: true
  ansible.builtin.apt:
    name: "{{ wireguard_packages }}"
    state: latest # noqa package-latest
    default_release: buster-backports
    update_cache: true
  notify:
    - restart wireguard
  when: ansible_os_family == "Debian" and ansible_lsb.major_release|int == 10

- name: Install wiregard using latest version from stable
  become: true
  ansible.builtin.apt:
    name: "{{ wireguard_packages }}"
    state: latest # noqa package-latest
    update_cache: true
  notify:
    - restart wireguard
  when: ansible_os_family == "Debian" and ansible_lsb.major_release|int >= 11

- name: Enable WireGuard kernel module
  become: true
  modprobe:
    name: wireguard
    state: present
  register: wireguard_module_enabled
  until: wireguard_module_enabled is succeeded
  retries: 10
  delay: 10
  notify:
    - restart wireguard
  failed_when: wireguard_module_enabled is failure
...
