---
# check if a distribution upgrade is required

- name: Checking if Buster update channel Done
  ansible.builtin.stat:
    path: "{{ apt_buster_flag_path }}"
  register: buster_channel_flag
  when: ansible_distribution_release == "stretch"

- name: Update to Buster stable channel # noqa command-instead-of-module
  become: true
  ansible.builtin.shell: >
    set -o pipefail &&
    apt-get --allow-releaseinfo-change update && touch {{ apt_buster_flag_path | quote }}
  when: ansible_distribution_release == "stretch" and not buster_channel_flag.stat.exists
  args:
    executable: /bin/bash
  register: cmd_output
  changed_when: cmd_output.rc != 0

- name: Checking if Bullseye update channel Done
  ansible.builtin.stat:
    path: "{{ apt_bullseye_flag_path }}"
  register: bullseye_channel_flag
  when: ansible_distribution_release == "buster"

- name: Update to Bullseye stable channel # noqa command-instead-of-module
  become: true
  ansible.builtin.shell: >
    set -o pipefail &&
    apt-get --allow-releaseinfo-change update && touch {{ apt_bullseye_flag_path | quote }}
  when: ansible_distribution_release == "buster" and not bullseye_channel_flag.stat.exists
  args:
    executable: /bin/bash
  register: cmd_output
  changed_when: cmd_output.rc != 0

- name: Checking if Bookworm update channel Done
  ansible.builtin.stat:
    path: "{{ apt_bookworm_flag_path }}"
  register: bookworm_channel_flag
  when: ansible_distribution_release == "bullseye"

- name: Update to Bookworm stable channel # noqa command-instead-of-module
  become: true
  ansible.builtin.shell: >
    set -o pipefail &&
    apt-get --allow-releaseinfo-change update && touch {{ apt_bookworm_flag_path | quote }}
  when: ansible_distribution_release == "bullseye" and not bookworm_channel_flag.stat.exists
  args:
    executable: /bin/bash
  register: cmd_output
  changed_when: cmd_output.rc != 0
...
