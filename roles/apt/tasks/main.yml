---
# This role contains apt settings
- name: Find source.d files
  find:
    paths: "{{ apt_sources_list_directory }}"
  register: files_sources

- name: Remove unwanted sources.d
  become: yes
  file:
    path: "{{ item.path }}"
    state: absent
  with_list: "{{ files_sources.files }}"

- name: Copy sources.list
  become: yes
  copy:
    src: "files/sources.list"
    dest: "{{ apt_directory }}/sources.list"
    owner: root
    group: root
    mode: u=rw,g=r,o=r

- name: Checking if Buster update channel Done
  stat:
    path: "{{ apt_buster_flag_path }}"
  register: buster_channel_flag

- name: Update to Buster stable channel
  become: yes
  shell: "apt-get --allow-releaseinfo-change update && touch {{ apt_buster_flag_path }}"
  when: buster_channel_flag.stat.exists == False

- name: Update and upgrade apt packages
  become: yes
  apt:
    upgrade: yes
    update_cache: yes
    cache_valid_time: 86400 #One day