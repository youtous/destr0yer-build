---
- name: Check if /etc/NetworkManager/NetworkManager.conf exists
  ansible.builtin.stat:
    path: "/etc/NetworkManager/NetworkManager.conf"
  register: network_manager_conf_present

- name: Create /etc/NetworkManager/NetworkManager.conf
  become: true
  ansible.builtin.copy:
    src: "files/NetworkManager.conf"
    dest: "/etc/NetworkManager/NetworkManager.conf"
    owner: root
    group: root
    mode: u=rw,g=r,o=r
  when: not network_manager_conf_present.stat.exists
  notify: Restart NetworkManager

- name: Disable NetworkManager auto-update /etc/resolv.conf
  become: true
  ansible.builtin.lineinfile:
    path: /etc/NetworkManager/NetworkManager.conf
    regexp: '^dns='
    insertafter: '^[main]'
    line: 'dns=none'
  when: not network_manager_conf_present.stat.exists
  notify: Restart NetworkManager

- name: Unlock /etc/resolv.conf
  become: true
  ansible.builtin.file:
    path: /etc/resolv.conf
    attributes: -i
  # if the Filesystem does not handle ioctl we are maybe on a vm
  ignore_errors: true # noqa ignore-errors

- name: Configure /etc/resolv.conf for DNSCrypt-proxy
  become: true
  ansible.builtin.template:
    src: "templates/resolv.conf.j2"
    dest: "/etc/resolv.conf"
    owner: root
    group: root
    mode: u=rw,g=r,o=r
  notify: Restart NetworkManager

# some server providers tries to overwrite resolv.conf...
- name: Ensure resolv.conf is not overwritable
  become: true
  ansible.builtin.file:
    path: /etc/resolv.conf
    owner: root
    group: root
    attributes: i
    mode: u=rw,g=r,o=r
  # if the Filesystem does not handle ioctl we are maybe on a vm
  ignore_errors: true # noqa ignore-errors
  when: lock_resolv_conf
...
