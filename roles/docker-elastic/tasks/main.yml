---
# This role setup an elastic-stack for logging management purposes

# https://github.com/elastic/elasticsearch-docker/blob/7c1dc434d32b88b414180cbddc9412acb41cb14c/README.md
- name: set vm.max_map_count to 262144 in sysctl
  become: yes
  sysctl: name={{ item.key }} value={{ item.value }}
  with_items:
    - { key: "vm.max_map_count", value: "262144" }

- name: Ensure elastic directory exists
  file:
    state: directory
    path: "{{ elastic_compose_file_dest_directory }}"

- name: Register deployment timestamp
  set_fact:
    elastic_deploy_timestamp: "{{ ansible_date_time.epoch }}"

- name: Ensure elastic config directories exists
  file:
    state: directory
    path: "{{ elastic_compose_file_dest_directory }}/config/{{ item }}"
  with_items:
    - elasticsearch
    - kibana
    - logstash
    - logstash/pipeline
    - heartbeat
    - journalbeat
    - metricbeat

- name: Copy elastic configs
  template:
    src: "templates/config/{{ item }}/{{ item }}.j2.yml"
    dest: "{{ elastic_compose_file_dest_directory }}/config/{{ item }}/{{ item }}.yml"
    mode: u=rw,g=,o=
  with_items:
    - elasticsearch
    - kibana
    - logstash
    - heartbeat
    - journalbeat
    - metricbeat

- name: Copy logstash pipeline conf
  template:
    src: "templates/config/logstash/pipeline/logstash.j2.conf"
    dest: "{{ elastic_compose_file_dest_directory }}/config/logstash/pipeline/logstash.conf"
    mode: u=rw,g=,o=

- name: Copy elastic stack
  template:
    src: templates/docker-compose.elastic.j2.yml
    dest: "{{ elastic_compose_file_dest }}"
    mode: u=rw,g=,o=
  when: not elastic_use_as_forwarder

- name: Copy elastic stack (forwarder)
  template:
    src: templates/docker-compose.elastic-forwarder.j2.yml
    dest: "{{ elastic_compose_file_dest }}"
    mode: u=rw,g=,o=
  when: elastic_use_as_forwarder

- name: Configure additional parameters for logstash with docker
  import_tasks: docker-logstash.yml

- name: Check if docker ipv4 iptables is enabled
  become: yes
  command: iptables -L DOCKER-USER
  register: docker_ipv4
  ignore_errors: True
  changed_when: false

- name: Configure docker logstash firewall ipv4
  import_tasks: docker-logstash-ipv4.yml
  when: docker_ipv4 is not failed

- name: Check if docker ipv6 iptables is enabled
  become: yes
  command: ip6tables -L DOCKER-USER
  register: docker_ipv6
  ignore_errors: True
  changed_when: false

- name: Configure docker logstash firewall ipv6
  import_tasks: docker-logstash-ipv6.yml
  when: docker_ipv6 is not failed

- name: Deploy elastic
  docker_stack:
    state: present
    prune: yes
    name: "{{ docker_elastic_stack_name }}"
    compose:
      - "{{ elastic_compose_file_dest }}"
  environment:
    DEPLOY_TIMESTAMP: "{{ elastic_deploy_timestamp }}"
    ELASTIC_CLUSTER_NAME: "{{ elastic_cluster_name }}"

    SMTP_HOSTNAME: "{{ alert_email_server }}"
    SMTP_PORT: "{{ alert_email_port }}"
    SMTP_USERNAME: "{{ alert_email_user }}"
    SMTP_PASSWORD: "{{ alert_email_password }}"
    SMTP_FROM: "{{ alert_email_from }}"
  notify: docker prune