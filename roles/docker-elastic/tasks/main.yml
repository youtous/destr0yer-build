---
# This role setup an elastic-stack for logging management purposes

# https://github.com/elastic/elasticsearch-docker/blob/7c1dc434d32b88b414180cbddc9412acb41cb14c/README.md
- name: set vm.max_map_count to 262144 in sysctl
  become: yes
  sysctl: name={{ item.key }} value={{ item.value }}
  with_items:
    - { key: "vm.max_map_count", value: "262144" }

- name: Ensure elastic directory exists
  file:
    state: directory
    path: "{{ elastic_compose_file_dest_directory }}"

- name: Register deployment timestamp
  set_fact:
    elastic_deploy_timestamp: "{{ ansible_date_time.epoch }}"

- name: Copy elastic stack config files
  copy:
    src: "files/config"
    dest: "{{ elastic_compose_file_dest_directory }}"
    mode: u=rw,g=,o=

- name: Ensure elastic beat directories exists
  file:
    state: directory
    path: "{{ elastic_compose_file_dest_directory }}/config/{{ item }}"
  with_items:
    - heartbeat
    - journalbeat
    - metricbeat

- name: Copy elastic beat configs
  template:
    src: "templates/config/{{ item }}/{{ item }}.j2.yml"
    dest: "{{ elastic_compose_file_dest_directory }}/config/{{ item }}/{{ item }}.yml"
    mode: u=rw,g=,o=
  with_items:
    - heartbeat
    - journalbeat
    - metricbeat

- name: Copy elastic stack
  template:
    src: templates/docker-compose.elastic.j2.yml
    dest: "{{ elastic_compose_file_dest }}"
    mode: u=rw,g=,o=

- name: Configure additional parameters for logstash with docker
  import_tasks: docker-logstash.yml

- name: Deploy elastic
  docker_stack:
    state: present
    prune: yes
    name: "{{ docker_elastic_stack_name }}"
    compose:
      - "{{ elastic_compose_file_dest }}"
  environment:
    DEPLOY_TIMESTAMP: "{{ elastic_deploy_timestamp }}"
  notify: docker prune