---
# Setup the required components to send logs from docker nodes to the logstash processor node.
# Transport will be done using TLS certificates (ensure encryption && identity)
# Logstash node will filter any non-authorized ip using UFW and internal mechanism.

- name: List existing logstash tcp/5000 UFW rules
  become: yes
  shell: "ufw status numbered | grep ' 5000 ' | awk -F\"[][]\" '{print $2}' | tr --delete [:blank:] | sort -rn"
  register: ufw_logstash_5000_rules

- name: UFW delete existing logstash rules - tcp/5000
  become: yes
  shell: "yes y | ufw delete {{ item }}"
  with_items: "{{ ufw_logstash_5000_rules.stdout_lines }}"

- name: Allow nodes firewall - tcp/5000 (logstash)
  become: yes
  ufw:
    rule: allow
    port: 5000
    src: "{{ item }}"
  with_items: "{{ logstash_allowed_ips }}"

- name: List existing logstash tcp/5044 UFW rules
  become: yes
  shell: "ufw status numbered | grep ' 5044 ' | awk -F\"[][]\" '{print $2}' | tr --delete [:blank:] | sort -rn"
  register: ufw_logstash_5044_rules

- name: UFW delete existing logstash rules - tcp/5044
  become: yes
  shell: "yes y | ufw delete {{ item }}"
  with_items: "{{ ufw_logstash_5044_rules.stdout_lines }}"

- name: Allow nodes firewall - tcp/5044 (logstash)
  become: yes
  ufw:
    rule: allow
    port: 5044
    src: "{{ item }}"
  with_items: "{{ logstash_allowed_ips }}"

- name: Allow from docker containers networks to this host - tcp/5000,5044 (logstash)
  become: yes
  ufw:
    rule: allow
    src: "172.16.0.0/12"
    port: "{{ item }}"
  with_items:
    - 5000
    - 5044

# Setup TLS using x509 certificates
- name: Setup logstash certificates folder
  file:
    path: "{{ logstash_certificates_directory }}"
    state: directory
    mode: u=rwx,g=,o=

- name: Copy logstash RootCA certificate
  copy:
    content: "{{ logstash_CA_certificate }}"
    dest: "{{ logstash_certificates_directory }}/{{ logstash_root_CA_certificate_name }}"
    mode: u=rw,g=,o=

- name: Copy logstash node certificate
  copy:
    content: "{{ logstash_node_certificate }}"
    dest: "{{ logstash_certificates_directory }}/{{ logstash_node_certificate_name }}.crt"
    mode: u=rw,g=,o=

- name: Copy logstash node private key
  copy:
    content: "{{ logstash_node_private_key }}"
    dest: "{{ logstash_certificates_directory }}/{{ logstash_node_certificate_name }}.key"
    mode: u=rw,g=,o=
  no_log: true
...