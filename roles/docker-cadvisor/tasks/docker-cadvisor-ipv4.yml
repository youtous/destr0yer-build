---
# ipv4 firewall rules

- name: Ensure docker external interfaces defined
  ansible.builtin.fail:
    msg: docker_external_interfaces not defined.
  when: docker_external_interfaces is not defined

## beginning of rules 9200 (external)

- name: List existing cadvisor tcp/9200 iptables rules
  become: true
  ansible.builtin.shell: >
    set -o pipefail &&
    iptables  -L DOCKER-USER  -n  --line-numbers | grep -zoP '.* 9200 .*\n' |  cut -d' ' -f1 | tr -d '\000' | sort -rn | sed '/^s*$/d'
  register: ufw_cadvisor_9200_rules
  changed_when: false

- name: iptables delete existing cadvisor rules - tcp/9200 # noqa no-changed-when
  become: true
  ansible.builtin.command: "iptables -D DOCKER-USER {{ item|quote }}"
  with_items: "{{ ufw_cadvisor_9200_rules.stdout_lines }}"
  when: ufw_cadvisor_9200_rules.stdout_lines | length > 0

- name: Drop other ips firewall - tcp/9200 (cadvisor external) # noqa no-changed-when
  become: true
  ansible.builtin.command: "iptables -I DOCKER-USER -i {{ item|quote }} -p tcp -m conntrack --ctorigdstport 9200 --ctdir ORIGINAL -j DROP"
  with_items: "{{ docker_external_interfaces }}"

- name: Allow nodes firewall - tcp/9200 (cadvisor external) # noqa no-changed-when
  become: true
  ansible.builtin.command: "iptables -I DOCKER-USER -i {{ item|quote }} -s {{ cadvisor_external_allowed_ip4s|join(',') }}
    -p tcp -m conntrack --ctorigdstport 9200 --ctdir ORIGINAL -j ACCEPT"
  with_items: "{{ docker_external_interfaces }}"

## end of rules 9200

## save rules across reboots
- name: Export DOCKER-USER iptables chain
  become: true
  ansible.builtin.command: iptables -S DOCKER-USER
  register: iptables_docker_user_rules
  changed_when: false

- name: Save DOCKER-USER iptables rules
  become: true
  ansible.builtin.blockinfile:
    create: true
    dest: "/etc/iptables.docker-user.rules.v4"
    mode: u=rw,g=r,o=
    block: |
      *filter

      {{ iptables_docker_user_rules.stdout }}

      COMMIT
    marker: "### {mark} ANSIBLE MANAGED BLOCK - IPv4 DOCKER-USER before rules ###"
  when: iptables_docker_user_rules is not failed
...
