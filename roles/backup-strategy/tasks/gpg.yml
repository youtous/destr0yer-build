# tasks file for duply-backup that import GPG keys
---
- name: Create (lock) directory which will contain flags
  become: true
  file:
    path: "{{ duply_backup_lock_directory }}"
    state: directory
    owner: root
    group: root
    mode: u=rwx,g=,o=

- name: Copy public keys
  become: true
  copy:
    content: "{{ item.key }}"
    dest: "{{ duply_backup_lock_directory }}/{{ item.name }}"
    owner: root
    group: root
    mode: u=rw,g=,o=
  with_items: "{{ backup_gpg_public_keys }}"
  register: copied_pub_keys

- debug: msg="Gets printed only if this item changed - {{item}}"
  with_items: "{{copied_pub_keys.results}}"

- name: import public keys
  become: true
  become_user: root
  shell: >
    gpg --import && touch {{ duply_backup_lock_directory }}/{{ item.name }}
  args:
    creates:
  with_items: "{{ backup_gpg_public_keys }}"

- name: import ownertrusts
  become: true
  become_user: root
  shell: >
    echo '{{ item.value }}' | gpg --import-ownertrust && touch {{ duply_backup_lock_directory }}/{{ item.name }}
  args:
    creates: "{{ duply_backup_lock_directory }}/{{ item.name }}"
  notify: update trustdb
  with_items: "{{ backup_gpg_ownertrusts }}"

- name: import private keys
  become: true
  become_user: root
  shell: >
    echo '{{ item.key }}' | gpg --allow-secret-key-import --batch --import && touch {{ duply_backup_lock_directory }}/{{ item.name }}
  args:
    creates: "{{ duply_backup_lock_directory }}/{{ item.name }}"
  with_items: "{{ backup_gpg_private_keys }}"