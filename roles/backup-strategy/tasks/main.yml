---
# This role setup a backup server using sftp and chroot
# ssh role must be used in order to have a properly configured server
- name: Install duply and duplicity packages
  become: true
  apt:
    name:
      - duplicity
      - duply

# generate per host GPG key using : https://github.com/Oefenweb/ansible-duply-backup#advance-configuration-gpg-enabled
# /!\ Be careful about ' characters, it's better not to have one in the passphrase
- name: Import GPG keys for root user
  import_tasks: gpg.yml

- name: Setup Duplicity backup strategy
  become: true
  import_role:
    name: oefenweb.duply-backup
  vars:
    duply_backup_profiles: "{{ backup_profiles }}"
    duply_backup_jobs: "{{ backup_jobs }}"


- name: Ensure cache backup directory is present
  become: true
  file:
    state: directory
    path: "{{ backup_cache_directory }}"
    owner: root
    group: root
    mode: u=rwx,g=,o=

#- name: Remove old version of paramiko
#  become: true
#  apt:
#    name: python-paramiko
#    state: absent
#
#- name: Install required librairies for paramiko
#  become: true
#  apt:
#    # list of packages according to https://cryptography.io/en/latest/installation/#building-cryptography-on-linux
#    name:
#      - build-essential
#      - libssl-dev
#      - libffi-dev
#      - python-dev

- name: Update python build tools
  become: true
  pip:
    executable: pip2 # it's a python 2 package
    name:
      - setuptools
      - wheel
    state: latest
    extra_args: --upgrade
#
#- name: Update paramiko crypto dependencies
#  become: true
#  pip:
#    executable: pip2 # it's a python 2 package
#    name:
#      - cffi
#      - cryptography
#    state: latest
#    extra_args: --upgrade

# our ssh client needs to be upgraded in order to support secure cyphers
- name: Install pexpect at latest version
  become: true
  pip:
    executable: pip2 # it's a python 2 package
    name: pexpect
    state: latest
    extra_args: --upgrade
