---
# This role contains oh-my-fish global installation
- name: Check if OMF is installed
  ansible.builtin.command: "ls {{ omf_installation_directory|quote }}"
  register: omf_present
  changed_when: false
  ignore_errors: true

- name: "Clone OMF from {{ omf_repo }}" # noqa git-latest
  become: true
  ansible.builtin.git:
    repo: "{{ omf_repo }}"
    dest: "{{ omf_installation_directory }}"
  when: omf_present is failed

- name: Install OMF
  become: true
  ansible.builtin.template:
    src: files/config-omf.fish.j2
    dest: /etc/fish/conf.d/config-omf.fish
    owner: root
    group: root
    mode: u=rw,g=rx,o=rx

- name: Check if OMF theme "{{ omf_theme }}" is installed
  ansible.builtin.command: "ls {{ omf_installation_directory|quote }}/themes/{{ omf_theme|quote }}"
  changed_when: false
  register: omf_theme_present
  ignore_errors: true

- name: "Clone OMF theme \"{{ omf_theme }}\" from {{ omf_theme_repo }}"
  become: true
  ansible.builtin.git: # noqa git-latest
    repo: "{{ omf_theme_repo }}"
    dest: "{{ omf_installation_directory }}/themes/{{ omf_theme }}"
  when: omf_theme_present is failed

- name: Check if default theme already exists
  ansible.builtin.stat:
    path: "{{ omf_default_theme_directory }}"
  register: omf_default_link

- name: Move default OMF theme
  become: true
  ansible.builtin.command: mv "{{ omf_default_theme_directory|quote }}" "{{ omf_default_theme_move_directory|quote }}"
  ignore_errors: true # noqa ignore-errors
  when: omf_default_link.stat.islnk is not defined or not omf_default_link.stat.islnk

- name: Ensure theme {{ omf_theme }} is set as default
  become: true
  ansible.builtin.file:
    src: "{{ omf_theme_directory }}"
    dest: "{{ omf_default_theme_directory }}"
    force: true
    state: link

- name: Copy theme overriding modifications
  become: true
  ansible.builtin.copy:
    src: "files/themes/{{ omf_theme }}/override-{{ item }}"
    dest: "{{ omf_theme_directory }}/{{ item }}"
    owner: root
    group: root
    mode: u=rw,g=r,o=r
  ignore_errors: true # noqa ignore-errors
  with_items:
    - fish_prompt.fish

- name: Install OMF plugins
  become: true
  ansible.builtin.git: # noqa git-latest
    repo: "{{ omf_plugin_repo_base }}{{ item }}"
    dest: "{{ omf_plugin_directory }}/{{ item }}"
  with_items: "{{ omf_plugins }}"
...
