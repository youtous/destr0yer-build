---
# This role contains oh-my-fish global installation
- name: Check if OMF is installed
  ansible.builtin.stat:
    path: "{{ omf_installation_directory }}"
  register: omf_present

- name: "Clone OMF from {{ omf_repo }}" # noqa git-latest
  become: true
  ansible.builtin.git:
    repo: "{{ omf_repo }}"
    dest: "{{ omf_installation_directory }}"
  when: not omf_present.stat.exists

- name: Install OMF
  become: true
  ansible.builtin.template:
    src: files/config-omf.fish.j2
    dest: /etc/fish/conf.d/config-omf.fish
    owner: root
    group: root
    mode: u=rw,g=rx,o=rx

- name: Check if OMF theme "{{ omf_theme }}" is installed
  ansible.builtin.stat:
    path: "{{ omf_installation_directory }}/themes/{{ omf_theme }}"
  register: omf_theme_present

- name: "Clone OMF theme \"{{ omf_theme }}\" from {{ omf_theme_repo }}"
  become: true
  ansible.builtin.git: # noqa git-latest
    repo: "{{ omf_theme_repo }}"
    dest: "{{ omf_installation_directory }}/themes/{{ omf_theme }}"
  when: not omf_theme_present.stat.exists

- name: Check if default theme already exists
  ansible.builtin.stat:
    path: "{{ omf_default_theme_directory }}"
  register: omf_default_link

- name: Move default OMF theme
  become: true
  ansible.builtin.command: mv "{{ omf_default_theme_directory|quote }}" "{{ omf_default_theme_move_directory|quote }}"
  when:
    - omf_default_link.stat.islnk is not defined or not omf_default_link.stat.islnk
    - omf_default_link.stat.isdir is defined and omf_default_link.stat.isdir

- name: Ensure theme {{ omf_theme }} is set as default
  become: true
  ansible.builtin.file:
    src: "{{ omf_theme_directory }}"
    dest: "{{ omf_default_theme_directory }}"
    force: true
    state: link

- name: Copy theme overriding modifications
  become: true
  ansible.builtin.copy:
    src: "files/themes/{{ omf_theme }}/override-{{ item }}"
    dest: "{{ omf_theme_directory }}/{{ item }}"
    owner: root
    group: root
    mode: u=rw,g=r,o=r
  with_items:
    - fish_prompt.fish

- name: Install OMF plugins
  become: true
  ansible.builtin.git: # noqa git-latest
    repo: "{{ omf_plugin_repo_base }}{{ item }}"
    dest: "{{ omf_plugin_directory }}/{{ item }}"
  with_items: "{{ omf_plugins }}"

- name: Enable bat alias in fish
  become: true
  ansible.builtin.copy:
    content: |
      # Ansible managed content!
      abbr --add cat 'bat'
    dest: /etc/fish/conf.d/bat.fish
    owner: root
    group: root
    mode: u=rw,g=r,o=r
  when: omf_enable_bat_alias

- name: Disable bat alias in fish
  become: true
  ansible.builtin.file:
    path: /etc/fish/conf.d/bat.fish
    state: absent
  when: not omf_enable_bat_alias
...
