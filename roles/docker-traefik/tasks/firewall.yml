---
# We need to patch DOCKER firewall for hosted containers to access caddy services
# (see: https://forums.docker.com/t/no-route-to-host-network-request-from-container-to-host-ip-port-published-from-other-container/39063/16)

- name: Verify traefik_opened_ports is defined
  ansible.builtin.assert:
    that: >
      traefik_opened_ports is defined
    msg: "traefik_opened_ports must be defined"

## Revoke all traefik rules
- name: "List existing traefik UFW rules - any/{{ item }}"
  become: true
  ansible.builtin.shell: >
    set -o pipefail &&
    ufw status numbered
    | grep -zoP '{% for port in traefik_opened_ports %}\[.*\]\s{{ port }}(?!\\d).*\n|{% endfor %}'
    | sed -E 's/\[\s*([0-9]+)\].*$/\1/g'  | tr --delete [:blank:] | sed 's/\x0//g' | sort -rn
    | sed '/^s*$/d'
  changed_when: false
  register: ufw_traefik_rules
  ignore_errors: true # in case no rule already exists
  args:
    executable: /bin/bash

- name: UFW delete existing traefik rules - tcp,udp
  become: true
  ansible.builtin.shell: >
    set -o pipefail &&
    (yes || true) | ufw delete {{ item|quote }}
  with_items: "{{ ufw_traefik_rules.stdout_lines }}"
  when: ufw_traefik_rules.stdout_lines | length > 0
  args:
    executable: /bin/bash

## End of revocation
- name: "Allow traefik ports (including containers) to pass firewall - any/{{ item }}"
  become: true
  community.general.ufw:
    rule: allow
    proto: any
    port: "{{ item }}"
  with_items: "{{ traefik_opened_ports }}"
...
