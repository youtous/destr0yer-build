---
- name: Create ServiceAccount
  become: true
  run_once: true
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: ServiceAccount
      metadata:
        name: "{{ k8s_service_account_admin_name }}"
        namespace: "{{ k8s_service_account_admin_namespace }}"
      automountServiceAccountToken: false
  environment:
    KUBECONFIG: "{{ k8s_service_account_admin_kubeconfig_path }}"

- name: Give admin permissions to ServiceAccount
  become: true
  run_once: true
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: rbac.authorization.k8s.io/v1
      kind: ClusterRoleBinding
      metadata:
        name: "{{ k8s_service_account_admin_name }}"
        namespace: "{{ k8s_service_account_admin_namespace }}"
      roleRef:
        apiGroup: rbac.authorization.k8s.io
        kind: ClusterRole
        name: cluster-admin
      subjects:
        - kind: ServiceAccount
          name: "{{ k8s_service_account_admin_name }}"
          namespace: "{{ k8s_service_account_admin_namespace }}"
  environment:
    KUBECONFIG: "{{ k8s_service_account_admin_kubeconfig_path }}"

- name: Fetch the kubernetes ca
  become: true
  ansible.builtin.command: >
    kubectl config view --raw
    -o {% raw %}go-template='{{index ((index (index .clusters 0) "cluster"))
    "certificate-authority-data" }}'{% endraw %}
  run_once: true
  changed_when: false
  register: _kube_ca_command
  failed_when: _kube_ca_command.rc != 0
  environment:
    KUBECONFIG: "{{ k8s_service_account_admin_kubeconfig_path }}"

- name: Generate kubeconfig file
  ansible.builtin.template:
    src: templates/config.j2.yml
    dest: "{{ k8s_service_account_admin_kubeconfig_destination }}"
    mode: u=rw,g=,o=
  vars:
    _kube_user: "{{ k8s_service_account_admin_name }}"
    _kube_server: "{{ k8s_service_account_admin_server }}"
    _kube_ca: "{{ _kube_ca_command.stdout }}"
...
