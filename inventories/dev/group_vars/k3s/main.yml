---
# Global k3s configuration for nodes (workers and controllers)
# See: https://docs.k3s.io/cli/agent#node

# TODO : https://docs.k3s.io/security/hardening-guide
# TODO : ensure that k3s is using node dns ::1

# address of the k3s control plane (should be a loadbalancer or a vip)
# until multiple addresses are supported (see https://github.com/k3s-io/k3s/issues/7325)
# this vip / url should be HA otherwise workers won't be able to work in the cluster
k3s_installation_registration_address: "{{ groups['k3s_control_node'] | map('extract', hostvars, ['ipv4_private']) | list | flatten | unique | first }}"

k3s_installation_server:
  secrets-encryption: true
  protect-kernel-defaults: true
  selinux: false # todo: set it to true

  # IPv4 Cluster IP for coredns service. Should be in your service-cidr range
  cluster-dns: "10.43.0.10"

  kube-apiserver-arg:
    # - 'admission-control-config-file=/var/lib/rancher/k3s/server/psa.yaml' # TODO : enable
    # - 'audit-log-path=/var/lib/rancher/k3s/server/logs/audit.log'
    # - 'audit-policy-file=/var/lib/rancher/k3s/server/audit.yaml'
    - 'audit-log-maxage=30'
    - 'audit-log-maxbackup=10'
    - 'audit-log-maxsize=100'
    - 'request-timeout=300s'
    - 'service-account-lookup=true'
    - 'service-node-port-range=25-16000' # allow self hosting w/o LB
  kube-controller-manager-arg:
    - 'terminated-pod-gc-threshold=10'
    - 'use-service-account-credentials=true'
  kubelet-arg:
    - 'streaming-connection-idle-timeout=5m'
    - 'make-iptables-util-chains=true'
    - 'node-ip={{ ipv4_private | first }},{{ ipv6_private | first }}' # ensure to use the private ip to communicate within the clister

  # network
  cluster-cidr: "10.42.0.0/16" # configure ipv4 and # TODO: ipv6 stack
  node-ip: "{{ ipv4_private | first }}"
  node-external-ip: "{{ ipv4 | first }}"

  # cillium requirements
  disable-network-policy: true # controlled by cilium (https://docs.cilium.io/en/stable/installation/k3s/)
  flannel-backend: 'none'  # This needs to be in quotes
  disable:
    - traefik
    - servicelb
    - coredns

k3s_installation_agent:
  protect-kernel-defaults: true
  selinux: false # todo: set it to true
  kubelet-arg:
    - 'streaming-connection-idle-timeout=5m'
    - 'make-iptables-util-chains=true'
    - 'node-ip={{ ipv4_private | first }}' # ensure to use the private ip to communicate within the clister

  node-name: "{{ hostname }}"
  with-node-id: false

  # network
  node-ip: "{{ ipv4_private | first }}"
  node-external-ip: "{{ ipv4 | first }}"

# configure cilium to match k3s cidr
cilium_k8s_helm_values:
  kubeProxyReplacement: "strict"

  k8sServiceHost: "{{ ipv4_private | first }}"
  k8sServicePort: 6443

  global:
    encryption:
      enabled: true
      nodeEncryption: true

  operator:
    replicas: 1 # 3 in case of HA

  ipam:
    mode: "cluster-pool"

    operator:
      clusterPoolIPv4PodCIDRList: "10.43.0.0/16" # define the service pool of ips (for all nodes)
      clusterPoolIPv4MaskSize: "24" # mask size for each node

  prometheus:
    enabled: true
    port: 19090
...
