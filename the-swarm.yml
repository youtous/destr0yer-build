---
# This play a docker swarm network.

- name: Install docker on all systems
  hosts: all
  roles:
    - docker
  vars_files:
    - secret_vars/all.yml
    - task_vars/sudo.yml
    - "secret_vars/{{ inventory_hostname }}.yml"
  tags: ["docker-setup"]

- name: Setup docker swarm mode on all systems
  hosts: all
  roles:
    - docker-swarm-tls
    - docker-log
  vars_files:
    - secret_vars/all.yml
    - task_vars/sudo.yml
    - "secret_vars/{{ inventory_hostname }}.yml"
  tags: ["docker-swarm-setup"]

- name: Initiate the primary manager
  hosts: primary_manager
  roles:
    - docker-initiate-swarm
  vars_files:
    - secret_vars/all.yml
    - task_vars/sudo.yml
    - "secret_vars/{{ inventory_hostname }}.yml"
  tags: ["docker-swarm-init"]

- name: Initiate managers
  hosts: managers
  roles:
    - docker-initiate-managers
  vars_files:
    - secret_vars/all.yml
    - task_vars/sudo.yml
    - "secret_vars/{{ inventory_hostname }}.yml"
  tags: ["docker-swarm-init"]

- name: Initiate workers
  hosts: workers
  roles:
    - docker-initiate-workers
  vars_files:
    - secret_vars/all.yml
    - task_vars/sudo.yml
    - "secret_vars/{{ inventory_hostname }}.yml"
  tags: ["docker-swarm-init"]

- name: Setup traefik reverse-proxy with consul
  hosts: primary_manager # we use the primary_manager as an entrypoint, docker-swarm will handle replicas if needed
  roles:
    - docker-traefik-consul
  vars_files:
    - secret_vars/all.yml
    - task_vars/sudo.yml
    - "secret_vars/{{ inventory_hostname }}.yml"
  tags: ["docker-swarm-traefik"]

- name: Setup docker-swarm monitoring tools
  hosts: primary_manager
  roles:
    - docker-portainer
    - docker-swarmprom
  vars_files:
    - secret_vars/all.yml
    - task_vars/sudo.yml
    - "secret_vars/{{ inventory_hostname }}.yml"
  tags: ["docker-swarm-monitoring"]

- name: Setup docker-swarm logging tools
  hosts: primary_manager
  roles:
    - docker-elastic
  vars_files:
    - secret_vars/all.yml
    - task_vars/sudo.yml
    - "secret_vars/{{ inventory_hostname }}.yml"
  tags: ["docker-swarm-elastic"]
...